# text-db-webapp
Slightly more complex K8s webapp template using nginx as a reverse proxy and to serve static files, a python/flask backend, and a database.

Essentially this is the <a href="https://github.com/khutchi2/stepup_k8s_webapp"> Stepup Webapp </a> with an updated architecture.

# Step up K8s Web App Setup Guide

This guide assumes the following:
- You've already gone through the <a href="https://github.com/khutchi2/simple_k8s_webapp?tab=readme-ov-file"> Simple K8s Webapp </a>
- Running K8s cluster using Rancher Desktop
- You already have K8s, kubectl, etc. installed

## I. dockerhub Repo
1. Because you've already walked through the simpler version of the app, just setup a new repository for this text-db web app.

## II. Project Structure
Same drill as before, either you can clone this repo, or set it all up yourself.  Because I don't want this README to be a novel, I'm going to skip including all of the file contents here and instead just include a brief description of what each file/component is for.
```
flask-k8s-app/
│
├── app/
│   ├── app.py          # Flask API backend
│   ├── schema.sql      # Database schema
│   ├── requirements.txt
│   └── Dockerfile      # Flask app Dockerfile
│
├── nginx/
│   ├── Dockerfile      # Nginx Dockerfile
│   ├── nginx.conf      # Nginx configuration
│   └── html/           # Static frontend files
│       ├── index.html  # Main HTML page
│       ├── css/
│       │   └── styles.css
│       └── js/
│           └── app.js
│
└── k8s/
    └── k8s-manifests.yaml  # Kubernetes deployment files

```
### 1. app
#### app.py
This is a basic Flask app with a REST API and a SQLite database.  There are endpoints for retrieving and adding items.  The database initializes when the app starts.

#### requirements.txt
A file for grabbing the needed dependencies for the app to run.

#### schema.sql
This gives the layout of the SQLite database that is generated by the backend and saved in the mounted volume on the K8s cluster.  This means that it will persist even if pods go down and need to be replaced.

#### Dockerfile
This will build the Flask app backend in a container.


### 2. k8s
#### `k8s-manifests.yaml`
This contains all of the parts and pieces needed to serve this up on a cluster.

### 3. nginx
#### Dockerfile
Builds an nginx image designed to run as non-root that will serve the front end and proxy to the backend.

#### nginx.conf
Configures nginx to serve the static fiiles for the front end and handle reqeusts for the backend.

#### html
##### index.html
Code for the home page of the application.

##### css/styles.css
Adds styling to index.html.

##### js/app.js
This interacts with the Flask backend api to allow for text entry and displaying the messages on the page.


## III. Deployment Steps
This will all be much the same as before.

1. Build the docker images in the ```/app``` and ```/nginx``` directories.
```bash
docker build -t <username>/<repo-name>:<tag> .
```
It might be recommended to use "flask" and "nginx" for the respective image tags.



2. Push the docker images to DockerHub, run:
```bash
docker push <username>/<repo-name>:<tag>
```

3. Apply the Kubernetes manifests and kick off spinning up the app by running:
```bash
kubectl apply -f k8s/k8s-manifests.yaml/
```

4. Find the pod name (and check that there haven't been any errors) by running:
```bash
kubectl get pods
```

5. To view the web app you'll first need to forward the port:
```bash
kubectl port-forward service/nginx-service 8080:80
```
6. Open a web browser and enter the following into the URL bar:
```
localhost:8080/
```
hopefully you'll see a page with a couple of text boxes.  Type something in and it should post it on the page.